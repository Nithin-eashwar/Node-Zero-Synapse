<!DOCTYPE html>
<html>
<head>
    <title>Synapse: Visual Blast Radius</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; margin: 0; }
        #network { width: 100vw; height: 100vh; border: 1px solid #444; }
        .controls { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; }
        input { padding: 8px; border-radius: 4px; border: none; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #stats { margin-top: 10px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>‚ö° Synapse Engine</h2>
        <button onclick="loadGraph()">üîÑ Refresh Graph</button>
        <div style="margin-top: 15px;">
            <input type="text" id="targetFunc" placeholder="Enter function name...">
            <button onclick="checkBlastRadius()">üí• Check Blast Radius</button>
        </div>
        <div id="stats"></div>
    </div>
    
    <div id="network"></div>

    <script type="text/javascript">
        let network = null;
        let rawData = null;

        // 1. Connect to your Local API
        async function loadGraph() {
            try {
                const response = await fetch('http://localhost:8000/graph');
                const data = await response.json();
                rawData = data;
                
                document.getElementById('stats').innerText = 
                    `Nodes: ${data.nodes.length} | Edges: ${data.edges.length}`;

                render(data.nodes, data.edges);
            } catch (error) {
                alert("Ensure server.py is running! Error: " + error);
            }
        }

        // 2. Render the Graph
        function render(nodes, edges) {
            const container = document.getElementById('network');
            
            // Format for Vis.js
            const visNodes = new vis.DataSet(nodes.map(n => ({ 
                id: n.id, 
                label: n.id, 
                color: "#97c2fc",
                shape: "dot",
                size: 20
            })));
            
            const visEdges = new vis.DataSet(edges.map(e => ({ 
                from: e.source, 
                to: e.target, 
                arrows: "to",
                color: { color: "#555" }
            })));

            const options = {
                physics: {
                    stabilization: false,
                    barnesHut: { gravitationalConstant: -2000, springLength: 200 }
                },
                nodes: { font: { color: "#fff" } }
            };

            network = new vis.Network(container, { nodes: visNodes, edges: visEdges }, options);
        }

        // 3. The "Blast Radius" Feature
        async function checkBlastRadius() {
            const target = document.getElementById('targetFunc').value;
            if (!target) return alert("Enter a function name!");

            try {
                const response = await fetch(`http://localhost:8000/blast-radius/${target}`);
                const data = await response.json();
                
                // Highlight the affected path
                const affectedSet = new Set(data.affected_functions);
                affectedSet.add(data.target); // Include the target itself

                // Update colors dynamically
                const allNodes = rawData.nodes.map(n => ({
                    id: n.id,
                    color: affectedSet.has(n.id) ? "#ff0000" : "#2B2B2B", // RED for danger, Dark for safe
                    size: affectedSet.has(n.id) ? 30 : 15,
                    label: n.id
                }));
                
                render(allNodes, rawData.edges);
                alert(`‚ö†Ô∏è Warning: Changing '${target}' breaks ${data.blast_radius_score} other functions!`);
                
            } catch (e) {
                alert("Function not found or API error.");
            }
        }

        // Auto-load on start
        loadGraph();
    </script>
</body>
</html>